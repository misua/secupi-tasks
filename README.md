# Secupi Gateway SSL Deployment on k3d Kubernetes

## Overview
This repository contains all the necessary configurations and documentation for deploying Secupi Gateway on a local k3d Kubernetes cluster with SSL verify-full mode enabled for secure PostgreSQL database connectivity and email masking functionality.

## Prerequisites
- k3d installed locally
- kubectl installed and configured
- Helm 3 installed
- OpenSSL and keytool for certificate generation

## Deployment Steps

### 1. Create k3d Cluster
```bash
k3d cluster create secupi-cluster --port "5432:5432@loadbalancer" --wait
kubectl create namespace secupi
```

### 2. Download and Extract Helm Chart
```bash
wget https://storage.googleapis.com/secupi-shared/secupi-gateway-postgresql-7.0.0-59.tgz
mkdir -p secupi-chart
tar -xzvf secupi-gateway-postgresql-7.0.0-59.tgz -C secupi-chart
```

### 3. Create GitLab Registry Secret
```bash
kubectl create secret docker-registry gitlab-registry-secret \
  --namespace secupi \
  --docker-server=registry.gitlab.com \
  --docker-username=gitlab \
  --docker-password=<YOUR_GITLAB_PAT> \
  --docker-email=<YOUR_EMAIL>
```

### 4. Deploy PostgreSQL with SSL/TLS
```bash
# Create TLS configuration
cat > postgresql-tls-values.yaml <<EOF
tls:
  enabled: true
  autoGenerated: true
  preferServerCiphers: true
EOF

# Deploy PostgreSQL
helm install postgresql bitnami/postgresql -n secupi -f postgresql-tls-values.yaml
```

### 5. Generate SSL Certificates for Secupi Gateway
```bash
mkdir -p ssl-certs
cd ssl-certs

# Generate private key
openssl genrsa -out gateway.key 2048

# Create certificate signing request
openssl req -new -key gateway.key -out gateway.csr -subj "/CN=secupi-gateway/O=Secupi/C=US"

# Generate self-signed certificate
openssl x509 -req -days 365 -in gateway.csr -signkey gateway.key -out gateway.crt

# Convert to PKCS12 format
openssl pkcs12 -export -in gateway.crt -inkey gateway.key \
  -out gateway.p12 -name secupi-gateway \
  -password pass:test123456

# Convert PKCS12 to Java KeyStore (JKS)
keytool -importkeystore \
  -srckeystore gateway.p12 -srcstoretype PKCS12 -srcstorepass test123456 \
  -destkeystore secupi-gateway.jks -deststoretype JKS -deststorepass test123456 \
  -alias secupi-gateway

# Create Kubernetes secret for the keystore
kubectl create secret generic secupi-gateway-gateway-keystore \
  --namespace secupi \
  --from-file=keystore.jks=secupi-gateway.jks
```

### 6. Configure Secupi Gateway
Create `values-custom.yaml` with the following configuration:

```yaml
image:
  repository: "registry.gitlab.com/secupi/secupi-gateway"
  tag: "7.0.0.59"

imagePullSecrets:
  - name: gitlab-registry-secret

# Environment variables
gateway:
  env:
    SECUPI_BOOT_URL: "https://damkil.azure.secupi.com/api/boot/download/1e81d3dee43740fbbcbd669a2c3ca3a7/secupi-boot-ea9abf50-9ebf-4e28-9a54-f56d75dec2e5.jar"
    GATEWAY_SERVER_HOST: "postgresql.secupi.svc.cluster.local"
    GATEWAY_SERVER_PORT: "5432"
    GAGEWAY_SERVER_DATABASE: "postgres"
    GATEWAY_SERVER_USERNAME: "postgres"
    GATEWAY_SERVER_PASSWORD: "lnZFbl9v7E"
    GATEWAY_SERVER_SSL_MODE: "verify-full"
    GATEWAY_SSL_ENABLED: "true"
    KEYSTORE_SSL_STOREPASS: "test123456"
    KEYSTORE_SSL_PATH: "/opt/secupi/etc/keystore.jks"
    KEYSTORE_SSL_ALIAS: "1"

# Service configuration
service:
  type: ClusterIP
  port: 5432
```

### 7. Deploy Secupi Gateway
```bash
helm install secupi-gateway ./secupi-chart/secupi-gateway-postgresql -n secupi -f values-custom.yaml
```

### 8. Verify Deployment
```bash
# Check pod status
kubectl get pods -n secupi

# Check service status
kubectl get svc -n secupi

# Set up port-forwarding for testing
kubectl port-forward service/secupi-gateway-gateway 5433:5432 -n secupi

# Test database connection and email masking
psql -h 127.0.0.1 -p 5433 -U postgres -d postgres -c "SELECT * FROM customers LIMIT 1;"
```

## Verification Results

✅ **SUCCESS** - Secupi Gateway successfully connects to PostgreSQL database through port-forwarding

✅ **SUCCESS** - Email addresses are properly masked when queried through the gateway
- Original email: `john.doe@example.com`
- Masked email: `XXXX0@example.com`

## Files in This Repository

- `postgresql-tls-values.yaml` - PostgreSQL TLS configuration values
- `values-custom.yaml` - Secupi Gateway custom configuration values
- `SECUPI_GATEWAY_SETUP_STEPS.md` - Consolidated step-by-step setup guide
- `SECUPI_DEPLOYMENT_SUMMARY.md` - Comprehensive deployment summary
- `ssl-certs/` - Directory containing SSL certificate generation files
- `.taskmaster/` - Task management files for the implementation

## Troubleshooting Notes

1. **Truststore Issue**: Initially attempted to configure truststore as a base64 string in values-custom.yaml, which caused Java SSL errors (`toDerInputStream rejects tag type 77`). Removed this configuration as it was not required for the gateway to function properly.

2. **PostgreSQL TLS Enablement**: PostgreSQL was initially deployed without TLS. Used Bitnami Helm chart's TLS configuration section to enable SSL with auto-generated certificates.

3. **Connection Testing**: Established port-forwarding on local port 5433 to test gateway connectivity and verify email masking functionality.

## Next Steps for Production Deployment

1. Replace self-signed certificates with proper SSL certificates
2. Configure network policies for restricted access
3. Set up proper monitoring and alerting
4. Implement backup and restore procedures
5. Configure Horizontal Pod Autoscaling (HPA)
6. Set up proper load balancing and external access
